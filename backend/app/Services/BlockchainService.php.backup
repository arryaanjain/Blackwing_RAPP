<?php

namespace App\Services;

use Exception;
use Illuminate\Support\Facades\Log;
use FurqanSiddiqui\Ethereum\Ethereum;
use FurqanSiddiqui\Ethereum\RPC\Geth;

class BlockchainService
{
    private $gethRPC;
    private $contractAddress;
    private $contractAbi;
    private $adminPrivateKey;
    
    public function __construct()
    {
        // Initialize Geth RPC connection (localhost Hardhat network)
        $this->gethRPC = new Geth("127.0.0.1", 8545);
        
        // Set contract address from deployment
        $this->contractAddress = env('BLOCKCHAIN_CONTRACT_ADDRESS', '0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512');
        
        // Set admin private key (first account from Hardhat)
        $this->adminPrivateKey = env('BLOCKCHAIN_ADMIN_PRIVATE_KEY', '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80');
        
        // Contract ABI (simplified for our functions)
        $this->contractAbi = [
            [
                "inputs" => [
                    ["name" => "_name", "type" => "string"],
                    ["name" => "_shareId", "type" => "string"],
                    ["name" => "_businessType", "type" => "string"],
                    ["name" => "_location", "type" => "string"]
                ],
                "name" => "registerCompany",
                "outputs" => [],
                "stateMutability" => "nonpayable",
                "type" => "function"
            ],
            [
                "inputs" => [
                    ["name" => "_name", "type" => "string"],
                    ["name" => "_shareId", "type" => "string"],
                    ["name" => "_specialization", "type" => "string"],
                    ["name" => "_location", "type" => "string"]
                ],
                "name" => "registerVendor",
                "outputs" => [],
                "stateMutability" => "nonpayable",
                "type" => "function"
            ],
            [
                "inputs" => [["name" => "_shareId", "type" => "string"]],
                "name" => "verifyByShareId",
                "outputs" => [["name" => "", "type" => "bool"]],
                "stateMutability" => "view",
                "type" => "function"
            ],
            [
                "anonymous" => false,
                "inputs" => [
                    ["indexed" => true, "name" => "walletAddress", "type" => "address"],
                    ["indexed" => false, "name" => "name", "type" => "string"],
                    ["indexed" => false, "name" => "shareId", "type" => "string"]
                ],
                "name" => "CompanyRegistered",
                "type" => "event"
            ],
            [
                "anonymous" => false,
                "inputs" => [
                    ["indexed" => true, "name" => "walletAddress", "type" => "address"],
                    ["indexed" => false, "name" => "name", "type" => "string"],
                    ["indexed" => false, "name" => "shareId", "type" => "string"]
                ],
                "name" => "VendorRegistered",
                "type" => "event"
            ]
        ];
    }

    /**
     * Register a company on the blockchain
     * 
     * @param string $name
     * @param string $shareId
     * @param string $businessType
     * @param string $location
     * @return array Transaction result
     */
    public function registerCompany(string $name, string $shareId, string $businessType, string $location): array
    {
        try {
            // Create contract instance
            $contract = new Contract($this->ethereumNode, $this->contractAddress, $this->contractAbi);
            
            // Prepare transaction data
            $txData = $contract->call("registerCompany", [$name, $shareId, $businessType, $location]);
            
            // Create transaction
            $transaction = $this->ethereumNode->personalNewTransaction()
                ->to($this->contractAddress)
                ->data($txData)
                ->gasLimit(500000)
                ->gasPrice(20000000000); // 20 Gwei
            
            // Sign and send transaction
            $signedTx = $transaction->sign($this->adminAccount);
            $txHash = $this->ethereumNode->personal()->sendRawTransaction($signedTx);
            
            Log::info('Company registered on blockchain', [
                'name' => $name,
                'shareId' => $shareId,
                'txHash' => $txHash
            ]);
            
            return [
                'success' => true,
                'transaction_hash' => $txHash,
                'message' => 'Company registered successfully on blockchain'
            ];
            
        } catch (Exception $e) {
            Log::error('Failed to register company on blockchain', [
                'error' => $e->getMessage(),
                'name' => $name,
                'shareId' => $shareId
            ]);
            
            return [
                'success' => false,
                'error' => $e->getMessage(),
                'message' => 'Failed to register company on blockchain'
            ];
        }
    }

    /**
     * Register a vendor on the blockchain
     * 
     * @param string $name
     * @param string $shareId
     * @param string $specialization
     * @param string $location
     * @return array Transaction result
     */
    public function registerVendor(string $name, string $shareId, string $specialization, string $location): array
    {
        try {
            // Create contract instance
            $contract = new Contract($this->ethereumNode, $this->contractAddress, $this->contractAbi);
            
            // Prepare transaction data
            $txData = $contract->call("registerVendor", [$name, $shareId, $specialization, $location]);
            
            // Create transaction
            $transaction = $this->ethereumNode->personalNewTransaction()
                ->to($this->contractAddress)
                ->data($txData)
                ->gasLimit(500000)
                ->gasPrice(20000000000); // 20 Gwei
            
            // Sign and send transaction
            $signedTx = $transaction->sign($this->adminAccount);
            $txHash = $this->ethereumNode->personal()->sendRawTransaction($signedTx);
            
            Log::info('Vendor registered on blockchain', [
                'name' => $name,
                'shareId' => $shareId,
                'txHash' => $txHash
            ]);
            
            return [
                'success' => true,
                'transaction_hash' => $txHash,
                'message' => 'Vendor registered successfully on blockchain'
            ];
            
        } catch (Exception $e) {
            Log::error('Failed to register vendor on blockchain', [
                'error' => $e->getMessage(),
                'name' => $name,
                'shareId' => $shareId
            ]);
            
            return [
                'success' => false,
                'error' => $e->getMessage(),
                'message' => 'Failed to register vendor on blockchain'
            ];
        }
    }

    /**
     * Verify if a share ID exists on the blockchain
     * 
     * @param string $shareId
     * @return array Verification result
     */
    public function verifyShareId(string $shareId): array
    {
        try {
            // Create contract instance
            $contract = new Contract($this->ethereumNode, $this->contractAddress, $this->contractAbi);
            
            // Call the verification function
            $result = $contract->call("verifyByShareId", [$shareId]);
            
            return [
                'success' => true,
                'verified' => (bool) $result,
                'shareId' => $shareId
            ];
            
        } catch (Exception $e) {
            Log::error('Failed to verify share ID on blockchain', [
                'error' => $e->getMessage(),
                'shareId' => $shareId
            ]);
            
            return [
                'success' => false,
                'error' => $e->getMessage(),
                'verified' => false
            ];
        }
    }

    /**
     * Get transaction status
     * 
     * @param string $txHash
     * @return array Transaction status
     */
    public function getTransactionStatus(string $txHash): array
    {
        try {
            $receipt = $this->ethereumNode->eth()->getTransactionReceipt($txHash);
            
            return [
                'success' => true,
                'status' => $receipt ? 'confirmed' : 'pending',
                'gasUsed' => $receipt['gasUsed'] ?? null,
                'blockNumber' => $receipt['blockNumber'] ?? null
            ];
            
        } catch (Exception $e) {
            return [
                'success' => false,
                'status' => 'failed',
                'error' => $e->getMessage()
            ];
        }
    }

    /**
     * Get the current block number
     * 
     * @return int|null
     */
    public function getCurrentBlockNumber(): ?int
    {
        try {
            return $this->gethRPC->eth_blockNumber();
        } catch (Exception $e) {
            Log::error('Failed to get current block number', ['error' => $e->getMessage()]);
            return null;
        }
    }

    /**
     * Check if blockchain connection is working
     * 
     * @return bool
     */
    public function isConnectionHealthy(): bool
    {
        try {
            $blockNumber = $this->getCurrentBlockNumber();
            return $blockNumber !== null;
        } catch (Exception $e) {
            return false;
        }
    }
}
